(function(){/*

 Copyright The Closure Library Authors.
 SPDX-License-Identifier: Apache-2.0
*/
var k=this||self;var n;n=typeof Symbol==="function"&&typeof Symbol()==="symbol"?Symbol.for?Symbol.for("jas"):Symbol("jas"):void 0;const p=typeof Symbol==="function"&&typeof Symbol()==="symbol"?n:"I",q=Object.getOwnPropertyDescriptor(Array.prototype,"C");Object.defineProperties(Array.prototype,{C:{get(){const a=t(this);return q?q.get.call(this)+"|"+a:a},configurable:!0,enumerable:!1}});
function t(a){function b(e,g){e&c&&d.push(g)}const c=a[p]|0,d=[];b(1,"IS_REPEATED_FIELD");b(2,"IS_IMMUTABLE_ARRAY");b(4,"IS_API_FORMATTED");b(2048,"STRING_FORMATTED");b(4096,"GBIGINT_FORMATTED");b(4096,"BINARY");b(8,"ONLY_MUTABLE_VALUES");b(32,"MUTABLE_REFERENCES_ARE_OWNED");b(64,"CONSTRUCTED");b(128,"TRANSFERRED");b(256,"HAS_SPARSE_OBJECT");b(512,"HAS_MESSAGE_ID");b(1024,"FROZEN_ARRAY");b(8192,"DESERIALIZED_FROM_BINARY");b(16384,"HAS_WRAPPER");b(32768,"LEAKED_MUTABLE_SUBSTRUCTURES");a=c>>16&1023||
536870912;a!==536870912&&d.push(`pivot: ${a}`);return d.join(",")};typeof Proxy!=="undefined"&&new Proxy({},{getPrototypeOf:u,setPrototypeOf:u,isExtensible:u,preventExtensions:u,getOwnPropertyDescriptor:u,defineProperty:u,has:u,get:u,set:u,deleteProperty:u,apply:u,construct:u});function u(){throw Error("this array or object is owned by JSPB and should not be reused, did you mean to copy it with copyJspbArray? See go/jspb-api-gotchas#construct_from_array");};function v(){};(function(){const a=k.jspbGetTypeName;k.jspbGetTypeName=a?b=>a(b)||void 0:v})();class w{get(a,b){chrome.storage.local.get(a,c=>{b(chrome.runtime.lastError?null:c)})}set(a){chrome.storage.local.set(a,function(){})}remove(a){chrome.storage.local.remove(a)}};const x=chrome.runtime.getURL("reader.html"),y=/^scholar[.]google[.][^.]+([.][^.]+)?$/,z="chrome-extension://"+chrome.runtime.id,A=["chrome-extension://efaidnbmnnnibpcajpcglclefindmkaj/viewer.html","chrome-extension://oemmndcbldboiebfnladdacbdfmadadm/content/web/viewer.html","chrome-extension://ieepebpjnkhaiioojkepfniodjmjjihl/data/pdf.js/web/viewer.html"];function B(a,b){if(!a)return"";for(const {name:c,value:d}of a)if(c&&c.toLowerCase()===b)return d||"";return""}
var E=function(a){a.g.size+a.i.size<=0||a.o||(a.o=!0,setTimeout(()=>{a.o=!1;a.i=a.g;a.g=new Map;E(a)},36E4))},G=function(a,b){var c=F;a=`${a} ${b}`;b=c.g.get(a);b||(b={},c.g.set(a,b),E(c));return b},H=function(a){a.h.size+a.j.size<=0||a.m||(a.m=!0,setTimeout(()=>{a.m=!1;const b=[];for(const c of a.j.values())b.push(c.ruleId);chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:b});a.j=a.h;a.h=new Map;H(a)},15E3))},I=function(a,b){var c=F;b=`${a} ${b}`;({F:b}=c.g.get(b)||c.i.get(b)||{});
if(!b)return Promise.resolve({v:"",A:"",B:"",parentFrameId:NaN});const d=Number(b.split(" ")[1]),{u:e}=c.g.get(b)||c.i.get(b)||{};a=`${a} ${0}`;a=c.g.get(a)||c.i.get(a)||{};const g=a.u||"";let h;const f=((h=a.l)==null?void 0:h.H)||"";c=c.h.get(b)||c.j.get(b);return(c?c.promise:Promise.resolve()).then(()=>({v:e||"",A:g,B:f,parentFrameId:d}))};
class J{constructor(){this.i=new Map;this.g=new Map;this.j=new Map;this.h=new Map;const a=chrome.extension.inIncognitoContext;this.D=a?1E8:1;this.m=this.o=!1;chrome.declarativeNetRequest.getSessionRules().then(b=>{const c=[];for(const d of b)(a&&d.id>=1E8||!a&&d.id<1E8)&&c.push(d.id);c.length<=0||chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:c})})}}const F=new J;
chrome.webRequest.onBeforeSendHeaders.addListener(a=>{if(!(a.tabId<0||a.type==="xmlhttprequest")){var b=B(a.requestHeaders,"referer"),c=a.url;G(a.tabId,a.frameId).G={url:c,referrer:b}}},{urls:["<all_urls>"]},["requestHeaders","extraHeaders"]);
chrome.webRequest.onHeadersReceived.addListener(a=>{if(a.tabId>=0&&a.type==="main_frame"){var b=a.url,c=a.statusCode,d=G(a.tabId,a.frameId);if(d.l&&d.l.s){if(c<300||c>=400)d.l.s=!1}else c>=300&&c<400?d.l={s:!0,H:b}:d.l=void 0}if(!(a.tabId<0||a.type==="xmlhttprequest"||(a.initiator||"").startsWith("chrome-extension://")||B(a.responseHeaders,"content-type").split(";",1)[0].trim().toLowerCase()!=="application/pdf")){c=a.tabId;d=a.url;b=F;a=`${c} ${a.frameId}`;var {G:e}=b.g.get(a)||b.i.get(a)||{};let g=
(e==null?void 0:e.referrer)||"";(e==null?void 0:e.url)!==d&&(g="");(e=b.h.get(a)||b.j.get(a))&&chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:[e.ruleId]});e=b.D++;c=chrome.declarativeNetRequest.updateSessionRules({addRules:[{action:{requestHeaders:[{header:"referer",operation:"set",value:g}],type:"modifyHeaders"},condition:{initiatorDomains:[(new URL(d)).hostname],tabIds:[c],urlFilter:`|${d}|`},id:e}]})||Promise.resolve();b.h.set(a,{ruleId:e,promise:c});H(b)}},{urls:["<all_urls>"]},
["responseHeaders"]);chrome.webNavigation.onCommitted.addListener(a=>{if(a.url!==x){var b=a.url;G(a.tabId,a.frameId).u=b}else{b=a.tabId;var c=a.parentFrameId;G(b,a.frameId).F=`${b} ${c}`}});
function K(a){chrome.windows.getCurrent(b=>{const c=Math.min(b.height,560),d=Math.min(b.width,650);chrome.windows.create({focused:!0,left:Math.round(b.left+Math.max(0,(b.width-d)/2)),top:Math.round(b.top+Math.max(0,(b.height-c)/2)),height:c,width:d,url:"local_file_access.html#wid="+b.id,type:"normal"});b={};b.fac=`${a+1}:${Date.now()}`;(new w).set(b)})}
chrome.extension.isAllowedFileSchemeAccess(function(a){a||chrome.webNavigation.onBeforeNavigate.addListener(function(){(new w).get(["fac"],b=>{b=((b||{}).fac||"").split(":");const c=Number(b[0])||0;b=(Number(b[1])||0)+12096E5*2**c;c>=4||Date.now()<b||chrome.extension.isAllowedFileSchemeAccess(function(d){d||K(c)})})},{url:[{urlPrefix:"file://",pathSuffix:".pdf"},{urlPrefix:"file://",pathSuffix:".PDF"}]})});
function L(a){const b={credentials:"include"};switch(a.method){case "GET":break;case "POST":if(typeof a.body!=="string")return null;b.method="POST";b.body=a.body;break;default:return null}typeof a.timeout==="number"&&(b.signal=AbortSignal.timeout(a.timeout));return b}function M(a){return[".proquest.com",".wiley.com",".ieee.org",".ebscohost.com"].find(b=>a.endsWith(b))}
function N(a,b){return new Promise(c=>{chrome.webNavigation.getAllFrames({tabId:b},d=>{d||c(!1);const e=new Map;var g=0;for(var h of d)d=h.frameId,e.set(d,h),h.url===a&&(g=d);g===0&&c(!0);h=g;var f=e.get(g);for(f||c(!1);h!==0;){h=f.parentFrameId;if(d=g=e.get(h))a:{let m=d=void 0;f=f.url;var l=g.url;try{m=new URL(f),d=new URL(l)}catch(C){d=!1;break a}f=M(m.origin);d=M(d.origin);d=!!f&&f===d}d||c(!1);f=g}c(!0)})})}
function O(a,b,c,d){a=a!==b;let e;try{e=new URL(b)}catch(g){}b=e?e.hash:"BAD";b=b===""||b.match(/^#page=([0-9]+(.[0-9]+)?)$/);return a&&d&&b?chrome.scripting.executeScript({target:{tabId:c},files:["historyscript-compiled.js"]}).then(g=>!!g[0].result).catch(()=>!1):Promise.resolve(!1)}
function P(a,b,c,d){return a!==b&&d?chrome.scripting.executeScript({target:{tabId:c},func:function(){return{width:window.innerWidth,height:window.innerHeight}}}).then(e=>e[0].result).catch(()=>Promise.resolve({width:0,height:0})):Promise.resolve({width:0,height:0})}function Q(a){return chrome.scripting.executeScript({target:{tabId:a},func:function(){return document.referrer}}).then(b=>y.test((new URL(b[0].result+"")).host)).catch(()=>!1)}
chrome.runtime.onConnect.addListener(a=>{const b=a.sender,c=b.tab.id;if(b.origin===z){var d=!0;a.onMessage.addListener(e=>{if(b.tab&&b.frameId!==void 0&&e&&typeof e==="object")switch(e.type){case "getUrl":I(b.tab.id,b.frameId).then(f=>{const l=f.v,m=f.A,C=f.B,S=f.parentFrameId;l||console.error("Failed to get URL to load",b);const T=Q(c);N(l,c).then(r=>{const U=O(l,m,c,r),V=P(l,m,c,r);Promise.all([U,V,T]).then(([W,D,X])=>{d&&a.postMessage({pdfUrl:l,topWindowUrlBeforeRedirects:C||m,isScholarTopReferrer:X,
isHistoryOnTopWindow:W,shouldShowSignedInFeatures:r,topWindowWidth:D.width,topWindowHeight:D.height,parentFrameId:S})})})},f=>{console.error("Failed to get URL to load, reason:",f,b)});break;case "fetch":const g=e.url,h=e.id;typeof g==="string"&&typeof h==="number"&&(e=L(e))&&fetch(g,e).then(f=>f.json()).then(f=>{d&&a.postMessage({type:"fetch",id:h,json:f})}).catch(f=>{d&&a.postMessage({type:"fetch",id:h,error:f.message})})}});a.onDisconnect.addListener(()=>{d=!1})}});let R=null;
async function Y(){const a=chrome.runtime.getURL("offscreen.html");if((await chrome.runtime.getContexts({contextTypes:["OFFSCREEN_DOCUMENT"],documentUrls:[a]})).length>0)return Promise.resolve();R?await R:(R=chrome.offscreen.createDocument({url:"offscreen.html",reasons:[chrome.offscreen.Reason.CLIPBOARD],justification:"Write text to the clipboard."}),await R,R=null)}async function Z(a,b){await Y();chrome.runtime.sendMessage({type:"offscreen-copy",text:a,timestamp:b})}
chrome.runtime.onMessage.addListener((a,b)=>{a&&b.origin===z&&typeof a==="object"&&typeof a.timestamp==="number"&&a.type==="background-copy"&&Z(a.text,a.timestamp)});async function aa(){for(const a of A)try{return await fetch(a),!0}catch(b){}return!1}chrome.runtime.onInstalled.addListener(a=>{a.reason===chrome.runtime.OnInstalledReason.INSTALL&&aa().then(b=>{b&&chrome.tabs.create({url:"https://scholar.google.com/scholar/reader-install.pdf"})})});}).call(this);
