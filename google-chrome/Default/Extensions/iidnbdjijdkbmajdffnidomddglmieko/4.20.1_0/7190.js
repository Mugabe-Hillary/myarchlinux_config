try{let e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},t=(new e.Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="6da0a23b-7c6e-42a5-b87c-71808352f505",e._sentryDebugIdIdentifier="sentry-dbid-6da0a23b-7c6e-42a5-b87c-71808352f505")}catch(e){}("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{}).SENTRY_RELEASE={id:"4.20.1"};(self.webpackChunk=self.webpackChunk||[]).push([[7190],{77190:(e,t,n)=>{n.r(t),n.d(t,{LtQbGcAdapter:()=>O,PreferredMode:()=>i});var a=n(23958),r=n(24295);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class s{static getInstance(){return s.instance||(s.instance=new s),s.instance}async getLanguage(){return(0,a.getConfig)("INPUT_LANGUAGE")}async getConfig(e){return(0,a.getConfig)(e)}async getRegionalLanguage(){return(0,a.getConfig)("REGIONAL_LANGUAGE")}async getIsPremium(){return(0,a.getConfig)("IS_PREMIUM_USER")}async setGCStorageClient(e){this.setStorageClient(e)}async setGCEventCallback(e){this.setEventCallback(e)}async setGCHttpClient(e){this.setHttpClient(e),this.httpClientForAdapter=e}async setGCTrackerClient(e){this.setTrackerClient(e)}async setGCLoggerClient(e){this.setLoggerClient(e)}async setGCCoreConfig(e,t){this.setCoreConfig(e,t)}async getComputeGrammarCheck(e,t,n,a,r,o=null,s=!1,i=-1,l=!1,c=!1,d="",g={}){return await this.computeGrammarCheck(e,t,n,a,r,o,s,i,l,c,d,g)}async forceRecommendation(e,t={}){return await this.recommendation(e,t)}async setSentenceForSkippingCheck(e){return await this.storeSentenceForSkippingCheck(e)}async spamCheck(){var e;await(null===(e=this.httpClientForAdapter)||void 0===e?void 0:e.call(this,"auth/spam-check",{method:"get"}))}async detectLanguageFromText(e,t){return this.detectLanguageFromGCCore(e,t)}constructor(){o(this,"setCoreConfig",void 0),o(this,"setHttpClient",void 0),o(this,"setLoggerClient",void 0),o(this,"computeGrammarCheck",void 0),o(this,"recommendation",void 0),o(this,"httpClientForAdapter",void 0),o(this,"setTrackerClient",void 0),o(this,"setStorageClient",void 0),o(this,"setEventCallback",void 0),o(this,"storeSentenceForSkippingCheck",void 0),o(this,"detectLanguageFromGCCore",void 0),this.setCoreConfig=a.setConfig,this.computeGrammarCheck=a.computeGrammarCheck,this.recommendation=a.recommendation,this.setHttpClient=a.setHTTPClient,this.setLoggerClient=a.setLoggerClient,this.setStorageClient=a.setStorageClient,this.storeSentenceForSkippingCheck=a.storeSentenceForSkippingCheck,this.setTrackerClient=a.setTrackerClient,this.detectLanguageFromGCCore=a.detectLanguage,this.setEventCallback=a.setEventCallback}}o(s,"instance",void 0);var i,l=s.getInstance();let c=e=>{let t=[65279,160],n=0;if(0===e.length)return n;for(let a=0;a<e.length;a+=1){let r=e.charCodeAt(a);t.includes(r)||(n=(n<<5)-n+r,n&=n)}return n},d={"en-us":"English (US)","de-de":"German (Germany)","pt-br":"Portuguese (Brazil)","ca-es":"Catalan (Spain)"},g=(e,t)=>{let n=u(e,t);return d[n]||"English (US)"},u=(e,t)=>t?`${(e||"en").toLowerCase()}-${t.toLowerCase()}`:e,m={log:console.log,info:console.info,warn:console.warn,error:console.error};let h={English:"EN",German:"DE",French:"FR",Spanish:"ES",Portuguese:"PT",Swiss_German:"DE-CH",Dutch:"NL"},p=[{code:h.Dutch,name:"Dutch"},{code:h.English,name:"English"},{code:h.French,name:"French"},{code:h.German,name:"German"},{code:h.Swiss_German,name:"German (Swiss)"},{code:h.Portuguese,name:"Portuguese (Brazilian)"},{code:h.Spanish,name:"Spanish"}],v={"\xa0":" ","'":"'","\u2019":"'","\u201c":'"',"\u201d":'"',"\u2018":"'"};function f(e){let t="";for(let n=0;n<e.length;n++)e[n]in v?t+=v[e[n]]:t+=e[n];return t}function R(e){try{let t=new URL(e);if(e.startsWith("https://docs.google.com/")){let n=function(e){let t=e.split("/"),n=t.length>3&&"docs.google.com"===t[2];if(n){let e=t[3];return null!=e?e:""}return""}(e);return n?t.origin+"/"+n:t.origin}return t.origin}catch(t){return e}}function _(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class C{static getInstance(){return C.instance||(C.instance=new C),C.instance}setAPIUrl(e){this.apiUrl=e}async _fetchApi(e,t,n,r){let o=this.apiUrl;if(!(o=(s=o).endsWith("/api/")?s:s.endsWith("/api")?s+"/":s.endsWith("/")?s+"api/":s+"/api/"))throw Error("QUILLBOT_API_URL is not set in the GC Core Config");var s;let i=await(0,a.getConfig)("USER_ID_TOKEN"),l=`${o}${e}`,{headers:c={},signal:d}=n||{},g={method:r,credentials:"include",headers:{"Content-type":"application/json; charset=UTF-8",...c,useridtoken:i},signal:d};return"GET"!==r&&"HEAD"!==r&&(g.body=JSON.stringify(t)),fetch(l,g)}async _makeRequest(e,t,n,a,r=1){let o;switch(e.toLowerCase()){case"post":o=await this._fetchApi(t,n,a,"POST");break;case"get":o=await this._fetchApi(t,{},a,"GET");break;case"delete":o=await this._fetchApi(t,n,a,"DELETE");break;default:throw Error(`${e} is not implemented`)}return 408===o.status&&r>0?(await l.spamCheck(),this._makeRequest(e,t,n,a,r-1)):{data:"post"===e?(await o.json()).data:o}}async request(e,t){let{method:n,json:a}=t,r=e.replace("api/","");return this._makeRequest(n,r,a,t)}constructor(){_(this,"apiUrl","")}}_(C,"instance",void 0);class S{static getInstance(){return S.instance||(S.instance=new S),S.instance}_initializeGCCore(){let e=C.getInstance();l.setGCHttpClient(e.request.bind(e)),l.setGCLoggerClient(m)}async setConfig(e,t){l.setGCCoreConfig(e,t)}async setLanguage(e){await l.getLanguage()!==e&&await l.setGCCoreConfig("INPUT_LANGUAGE",e)}async setGCHttpClient(e){l.setGCHttpClient(e)}async setGCTrackerClient(e){l.setGCTrackerClient(e)}async setLoggerClient(e){l.setGCLoggerClient(e)}async setStorageClient(e){l.setGCStorageClient(e)}async setEventCallback(e){l.setGCEventCallback(e)}async setRegionalLanguage(e){await l.getRegionalLanguage()!==e&&await l.setGCCoreConfig("REGIONAL_LANGUAGE",e)}async setIsPremium(e){"true"===await l.getIsPremium()!==e&&await l.setGCCoreConfig("IS_PREMIUM_USER",`${e}`)}async getIsPremium(){return l.getIsPremium()}async getInputLanguage(){return l.getLanguage()}async getRegionalLangauge(){return l.getRegionalLanguage()}setPremium(e){l.setGCCoreConfig("IS_PREMIUM_USER",`${e}`)}async grammarCheck(e,t,n){let a={"qb-Product":"GRAMMAR_CHECKER",...e.header};return l.getComputeGrammarCheck(e.prevState,e.currentState,e.gcParams,t,n,e.signal,e.hasUserAcceptedSuggestion,e.changedParagraphsSentencesLength,e.shouldCallRecommendation,e.appliedFixAll,e.writingGoal,a)}async forceRecommendation(e,t={}){return l.forceRecommendation(e,t)}async detectLanguageFromText(e,t){return l.detectLanguageFromText(e,t)}async storeSentenceForSkippingCheck(e){return l.setSentenceForSkippingCheck(e)}async spamCheck(){await l.spamCheck()}constructor(){this._initializeGCCore()}}var E,T,I;I=void 0,(T="instance")in(E=S)?Object.defineProperty(E,T,{value:I,enumerable:!0,configurable:!0,writable:!0}):E[T]=I;class y{_defaultLTResponse(){return{language:{name:"",code:"",detectedLanguage:{name:"",code:"",confidence:0,source:""}},matches:[],sentenceRanges:[],extendedSentenceRanges:[]}}_createLanguageObject(e,t,n){return{name:e,code:t,detectedLanguage:{name:e,code:t,confidence:n,source:""}}}_createSentenceRanges(e){return e.sentences.map((e=>[e.start,e.end]))}_createExtendedSentenceRanges(e,t,n){return e.sentences.map((e=>{let a={from:e.start,to:e.end,detectedLanguages:[{language:t,rate:0}]};return n&&(a.checkStatus=n(e)),a}))}_getGrammarMatches(e,t){var n;let a=[];return null==e||null===(n=e.sentences)||void 0===n||n.forEach((e=>{var n,r,o;let s=(null==e||null===(n=e.grammarResponse)||void 0===n?void 0:n.modelID)||"";null==e||null===(r=e.grammarResponse)||void 0===r||null===(o=r.contentToReplace)||void 0===o||o.forEach((e=>{if(this._isReplacementInvalid(e)||e.isSuppressed)return;let n=this._createLTMatch(e,t,s);a.push(n)}))})),a}_isReplacementInvalid(e){let t=""===(null==e?void 0:e.replacementWord),n=""===(null==e?void 0:e.originalWord),a=f(null==e?void 0:e.replacementWord)===f(null==e?void 0:e.originalWord);return t&&n||a}_createLTMatch(e,t,n){var a,r,o,s;let i=(null===(a=e.explainers)||void 0===a?void 0:a[0])||{},l=(null===(r=i.multiple_spelling_suggestion)||void 0===r?void 0:r.filter((t=>t!==e.originalWord)))||[],c=this._getIssueType(e,i),d=this._getRuleType(e,c),g=[];return g="style"===c?(null==e||null===(o=e.suggestedWords)||void 0===o?void 0:o.suggestions.map((e=>({value:e||"",shortDescription:""}))))||[]:[{value:(null==e?void 0:e.replacementWord)||"",shortDescription:""},...l.map((e=>({value:e||"",shortDescription:""})))],{message:i.user_explanation||"",shortMessage:i.category||"",goodExample:i.good_example||"",badExample:i.bad_example||"",replacements:g,offset:null==e?void 0:e.startIndex,length:(null==e?void 0:e.endIndex)-(null==e?void 0:e.startIndex)+1,type:{typeName:i.type||""},rule:{id:d,description:i.example_summary||"",issueType:c,urls:[{value:""}],category:{id:null!==(s=i.error_type_id)&&void 0!==s?s:"",name:i.title||""},isPremium:t,confidence:0,operation:i.operation||"",modelId:n||"",textDiffs:i.textDiffs||[],highConfidence:(null==e?void 0:e.highConfidence)||!1,confidenceScore:(null==e?void 0:e.confidenceScore)||0},ignoreForIncompleteSentence:!1,contextForSureMatch:0}}_getIssueType(e,t){return t.error_type_name?t.error_type_name:e.isSuggestedWord?"style":""}_getRuleType(e,t){return e.isSpellingSuggestion?"SPELLING_RULE":t||e.originalWord+"/"+e.replacementWord}_convertToSingleSentenceArray(e){for(let t=e.length-1;t>0;t--){let n=e[t-1],a=e[t];n.sentences.push(...a.sentences),e.splice(t,1)}return e}}class L extends y{static getInstance(){return L.instance||(L.instance=new L),L.instance}transform(e){var t;let{paragraphState:n,langData:a,isPremium:r=!1}=e,{language:o,confidence:s,region:i}=a,l=null===(t=this._convertToSingleSentenceArray(n))||void 0===t?void 0:t[0],c=function(e){let t=new Set,n=new Set;try{for(let s of e.sentences){var a,r,o;null==s||null===(a=s.grammarResponse)||void 0===a||null===(r=a.contentToReplace)||void 0===r||r.forEach((e=>{e.modelID&&""!==e.modelID.trim()&&"NA"!==e.modelID.trim()&&t.add(e.modelID)})),(null==s||null===(o=s.grammarResponse)||void 0===o?void 0:o.modelID)&&""!==s.grammarResponse.modelID.trim()&&"NA"!==s.grammarResponse.modelID.trim()&&n.add(s.grammarResponse.modelID)}return t.size>0?[...t]:[...n]}catch(e){return[]}}(l),d=g(o,i),m=u(o,i),h=this._defaultLTResponse();return h.language=this._createLanguageObject(d,m,s),h.sentenceRanges=this._createSentenceRanges(l),h.extendedSentenceRanges=this._createExtendedSentenceRanges(l,o,(e=>{var t;return(null==e||null===(t=e.grammarResponse)||void 0===t?void 0:t.timedOut)?"failure":"success"})),h.matches=this._getGrammarMatches(l,r),h.metaData={textErrors:{errorModelId:c}},h}}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(L,"instance",void 0);let P=L.getInstance();class D extends y{static getInstance(){return D.instance||(D.instance=new D),D.instance}transform(e){var t;let{paragraphState:n,langData:a,isPremium:r=!1}=e,{language:o,confidence:s,region:i}=a,l=null===(t=this._convertToSingleSentenceArray(n))||void 0===t?void 0:t[0],c=function(e){let t=new Set,n=new Set;try{for(let i of e.sentences){var a,r,o,s;null==i||null===(a=i.recommendationResponse)||void 0===a||null===(r=a.recommendations)||void 0===r||r.forEach((e=>{e.modelId&&""!==e.modelId.trim()&&t.add(e.modelId)})),(null==i||null===(o=i.recommendationResponse)||void 0===o?void 0:o.model_id)&&""!==i.recommendationResponse.model_id.trim()&&n.add(null===(s=i.recommendationResponse)||void 0===s?void 0:s.model_id)}return t.size>0?[...t]:[...n]}catch(e){return[]}}(l),d=g(o,i),m=u(o,i),h=this._defaultLTResponse();return h.language=this._createLanguageObject(d,m,s),h.sentenceRanges=this._createSentenceRanges(l),h.extendedSentenceRanges=this._createExtendedSentenceRanges(l,o),h.matches=this._getRecommendationMatches(l,r),h.metaData={textErrors:{recommendationModelId:c}},h}_getRecommendationMatches(e,t){var n;let a=[];return null==e||null===(n=e.sentences)||void 0===n||n.forEach((e=>{if(null==e?void 0:e.recommendationResponse){let n=this._getRecommendationLTMatches(null==e?void 0:e.recommendationResponse,t);a.push(...n)}})),a}_getRecommendationIssueType(e){return e.isPhraseLevel?"PHRASAL_RECOMMENDATION":"RECOMMENDATION"}getTitle(e,t){var n;return t||!0===e.isLocked||!1===e.isLocked||void 0===e.isLocked&&(null==e||null===(n=e.text)||void 0===n?void 0:n.length)>0?e.cardName:e.upsellCardName}_getRecommendationLTMatches(e,t){var n;let a=[];return null==e||null===(n=e.recommendations)||void 0===n||n.forEach((n=>{var r;null==n||null===(r=n.phrases)||void 0===r||r.map((r=>{var o;let s=n.type,i=r.originalText||"",l=(null==r?void 0:r.text)||"";this._isReplacementInvalid({originalWord:i,replacementWord:l})||i.trim()===l.trim()||t&&"RECOMMENDATION"===this._getRecommendationIssueType(n)&&0===(null==r||null===(o=r.text)||void 0===o?void 0:o.length)||a.push({message:r.toolTip||"",shortMessage:this.getTitle(r,t)||"",goodExample:"",badExample:"",replacements:[{value:r.text||"",shortDescription:""}],offset:r.start,length:r.end-r.start,type:{typeName:""},rule:{id:s,description:"",issueType:this._getRecommendationIssueType(n),urls:[{value:""}],category:{id:r.internalErrorCategory||"",name:r.category||""},isPremium:t,confidence:0,operation:"",modelId:e.model_id||"",textDiffs:(null==r?void 0:r.textDiffs)||[],highConfidence:!1,confidenceScore:0,isPhrase:n.isPhraseLevel,phraseDiff:r.phraseDiff||[]},isLocked:r.isLocked,ignoreForIncompleteSentence:!1,contextForSureMatch:0})}))})),a}transformForceRecommendation(e){var t,n,a,r;let{recommendation:o,langData:s,isPremium:i=!1}=e,{language:l,confidence:c,region:d}=s,m=g(l,d),h=u(l,d),p=this._defaultLTResponse();p.language=this._createLanguageObject(m,h,c),p.sentenceRanges=o.map((e=>[null!==(t=e.offset)&&void 0!==t?t:0,e.text.length+(null!==(n=e.offset)&&void 0!==n?n:0)])),p.extendedSentenceRanges=o.map((e=>({from:null!==(a=e.offset)&&void 0!==a?a:0,to:e.text.length+(null!==(r=e.offset)&&void 0!==r?r:0),detectedLanguages:[{language:l,rate:0}]})));let v=[];null==o||o.forEach((e=>{let t=this._getRecommendationLTMatches(e,i);t&&v.push(...t)})),p.matches=v;let f=null==o?void 0:o.flatMap((e=>{var t;return null===(t=e.recommendations)||void 0===t?void 0:t.map((e=>e.modelId))})),R=o.map((e=>e.model_id));return p.metaData={textErrors:{recommendationModelId:f.length>0?f:R}},p}}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(D,"instance",void 0);let b=D.getInstance();function A(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e.LEGACY_HTTP="legacy_http",e.WS="ws",e.WS_WITH_NON_GDOCS="ws_with_non_gdocs",e.WS_WEBAPP="ws_webapp"}(i||(i={}));class w{transformResponseAccToParagraphs(){try{var e,t,n,a,o,s,i,l,c,d,g,u,m,h,p,v,f,R,_;let C=0,S=JSON.parse(JSON.stringify(this.gcParaMap)),E=null===(e=Object.values(S).find((e=>e.language)))||void 0===e?void 0:e.language;if(!E)throw Error("LanguageNotFound");let T={language:E,matches:[],sentenceRanges:[],extendedSentenceRanges:[],metaData:{textErrors:{errorModelId:Array.from(new Set(this.errorModelIds)),recommendationModelId:Array.from(new Set(this.recommendationModelIds))},errorInfo:[]}};for(let e=0;e<this.paragraphs.length;e++){let t=this.paragraphs[e].text.length,r=null===(n=S[e].sentenceRanges)||void 0===n?void 0:n.map(((t,n)=>{var a;return n===((null===(a=S[e].sentenceRanges)||void 0===a?void 0:a.length)||0)-1?[t[0]+C,t[1]+C+1]:[t[0]+C,t[1]+C]})),E=null===(a=S[e].extendedSentenceRanges)||void 0===a?void 0:a.map(((t,n)=>{var a;return{from:t.from+C,to:n===((null===(a=S[e].sentenceRanges)||void 0===a?void 0:a.length)||0)-1?t.to+C+1:t.to+C,detectedLanguages:t.detectedLanguages,checkStatus:t.checkStatus}}));T.sentenceRanges=null===(o=T.sentenceRanges)||void 0===o?void 0:o.concat(r||[]),T.extendedSentenceRanges=null===(s=T.extendedSentenceRanges)||void 0===s?void 0:s.concat(E||[]);let I=S[e].matches.map((e=>({...e,offset:e.offset+C}))),y=null===(i=this.recommendationParaMap[e])||void 0===i||null===(l=i.matches)||void 0===l?void 0:l.map((e=>{var t,n;let a={...e,offset:e.offset+C};return(null===(t=e.rule)||void 0===t?void 0:t.phraseDiff)&&(null===(n=e.rule)||void 0===n?void 0:n.phraseDiff.length)>0&&(a.rule={...e.rule,phraseDiff:e.rule.phraseDiff.map((e=>({...e,sourceStart:e.sourceStart+C,sourceEnd:e.sourceEnd+C,targetStart:e.targetStart+C,targetEnd:e.targetEnd+C})))}),a}));if(T.matches=[...T.matches||[],...I||[],...y||[]],(null!==(u=null===(c=S[e].metaData)||void 0===c||null===(d=c.errorInfo)||void 0===d||null===(g=d[0])||void 0===g?void 0:g.totalSentences)&&void 0!==u?u:0)>0){let t=null===(m=S[e].metaData)||void 0===m||null===(h=m.errorInfo)||void 0===h?void 0:h[0],n=null===(p=this.recommendationParaMap[e])||void 0===p||null===(v=p.metaData)||void 0===v||null===(f=v.errorInfo)||void 0===f?void 0:f[0],a={totalSentences:(null==t?void 0:t.totalSentences)||0,totalGcErrors:null==t?void 0:t.totalGcErrors,totalRecoErrors:null==n?void 0:n.totalRecoErrors,errorCodes:[...(null==t?void 0:t.errorCodes)||[],...(null==n?void 0:n.errorCodes)||[]]};null===(R=T.metaData)||void 0===R||null===(_=R.errorInfo)||void 0===_||_.push(a)}C=C+t+2}return this._notifyClient({eventName:r.ClientEvents.GC_MODEL_STATS,data:{hostUrl:null===(t=this._metaData)||void 0===t?void 0:t.hostUrl,editorId:this.editorId,...this._analyticsData}}),this._notifyClient({eventName:r.ClientEvents.GC_RECOM_RES,data:{gcRes:S,recomRes:this.recommendationParaMap,ltRes:T}}),T}catch(e){if("LanguageNotFound"===e.message)throw e;return{}}}handleFormulateAndResolveResponse(){var e,t;try{let t=this.transformResponseAccToParagraphs();this.isGCDone=!0,this.finalizedLTResponse=t,null===(e=this.resolveResponse)||void 0===e||e.call(this,t)}catch(e){null===(t=this.rejectResponse)||void 0===t||t.call(this,e)}}_addMetaToLTResponse(e,t){var n,a,o,s,i,l,c;e.metaData=e.metaData||{textErrors:{},errorInfo:[{totalSentences:0,errorCodes:[]}]};let d=e.metaData.errorInfo?e.metaData.errorInfo[0]:{totalSentences:0,errorCodes:[]};!t.sentenceRanges||-1===t.sentenceRanges[0][1]||(d.totalSentences=t.sentenceRanges.length,(null==t?void 0:t.isCached)||(this._analyticsData.numberOfSentencesProcessedForGC+=t.sentenceRanges.length)),(null==t?void 0:t.isCached)||(t.type===r.ChunkType.SentenceSuggestionsGC?this._analyticsData.errors.push({isRecommendation:!1,modelID:null===(n=t.modelIDs)||void 0===n?void 0:n.filter((e=>"string"==typeof e)),category:""}):t.type===r.ChunkType.SentenceSuggestionsRecommendation&&t.suggestions.length&&(this._analyticsData.numberOfSentencesProcessedForReco+=1,this._analyticsData.errors.push({isRecommendation:!0,modelID:null===(a=t.modelIDs)||void 0===a?void 0:a.filter((e=>"string"==typeof e)),category:null===(o=t.suggestions[0])||void 0===o||null===(s=o.rule)||void 0===s||null===(i=s.category)||void 0===i?void 0:i.name}))),t.errorCode&&(d.errorCodes.push(t.errorCode),t.type===r.ChunkType.SentenceSuggestionsGC?d.totalGcErrors=(null!==(l=d.totalGcErrors)&&void 0!==l?l:0)+1:t.type===r.ChunkType.SentenceSuggestionsRecommendation&&(d.totalRecoErrors=(null!==(c=d.totalRecoErrors)&&void 0!==c?c:0)+1))}handleGCResponse(e,t){return new Promise(((n,a)=>{var o;this.resolveResponse=n,this.rejectResponse=a,null===(o=this.gcMergedObservable)||void 0===o||o.subscribe((t=>{try{let{source:a,data:o}=t;this.gcParaMap[a]=this.gcParaMap[a]||{matches:[]};let s=this.gcParaMap[a];var n;if(o.type===r.ChunkType.SentenceSplitter)s.language=o.language,s.sentenceRanges=o.sentenceRanges,s.extendedSentenceRanges=null===(n=o.sentenceRanges)||void 0===n?void 0:n.map((e=>{var t,n;return{from:e[0],to:e[1],detectedLanguages:[{language:(null==o||null===(t=o.language)||void 0===t||null===(n=t.code)||void 0===n?void 0:n.split("-")[0])||"en",rate:0}]}})),this._addMetaToLTResponse(s,o);if(o.type===r.ChunkType.SentenceSuggestionsGC){s.matches=[...s.matches,...o.suggestions];let e=s.extendedSentenceRanges||[];e[a]&&(e[a].checkStatus=o.errorCode?"failure":"success"),s.extendedSentenceRanges=e,this._addMetaToLTResponse(s,o)}o.type===r.ChunkType.SentenceSuggestionsGCCompleted&&this.returnFromWs&&(this.errorModelIds=[...this.errorModelIds,...o.modelIDs||[]],null==e||e(s))}catch(e){a(e)}}),(()=>{try{this.isRecommendationEnabled?this.handleRecommendationResponse(t):((0,r.logTimeForAction)(r.LogActionPrefix.LT_QB_GC_ADAPTER,{type:"GC_COMPLETED",mode:"WS",startTime:this.startTime,currentTime:Date.now(),timeDiff:Date.now()-this.startTime,editorId:this.editorId}),this.handleFormulateAndResolveResponse())}catch(e){a(e)}}),(e=>{a(e)}))}))}handleRecommendationResponse(e){var t;null===(t=this.recommendationMergedObservable)||void 0===t||t.subscribe((t=>{try{let{source:a,data:o}=t;this.recommendationParaMap[a]=this.recommendationParaMap[a]||{matches:[]};let s=this.recommendationParaMap[a];if(o.type===r.ChunkType.SentenceSuggestionsRecommendation){if(s.matches=[...s.matches,...o.suggestions],this.recommendationModelIds=[...this.recommendationModelIds,...o.modelIDs||[]],this.isGCDone){var n;let t=0;for(let e=0;e<a;e++)t+=this.paragraphs[e].text.length+2;let r=null===(n=o.suggestions)||void 0===n?void 0:n.map((e=>({...e,offset:e.offset+t}))),s={...this.finalizedLTResponse,matches:r||[]};null==e||e(s)}this._addMetaToLTResponse(s,o)}}catch(e){}}),(()=>{this.isRecommendationEnabled&&((0,r.logTimeForAction)(r.LogActionPrefix.LT_QB_GC_ADAPTER,{type:"GC_WITH_RECOMMENDATION_COMPLETED",mode:"WS",startTime:this.startTime,currentTime:Date.now(),timeDiff:Date.now()-this.startTime,editorId:this.editorId}),this.handleFormulateAndResolveResponse())}),(e=>{}))}constructor(e,t,n,a,r,o,s,i){A(this,"gcParaMap",{}),A(this,"recommendationParaMap",{}),A(this,"gcMergedObservable",void 0),A(this,"recommendationMergedObservable",void 0),A(this,"paragraphs",void 0),A(this,"isGCDone",!1),A(this,"finalizedLTResponse",{}),A(this,"returnFromWs",void 0),A(this,"startTime",void 0),A(this,"editorId",void 0),A(this,"resolveResponse",void 0),A(this,"rejectResponse",void 0),A(this,"isRecommendationEnabled",!0),A(this,"errorModelIds",[]),A(this,"recommendationModelIds",[]),A(this,"_notifyClient",void 0),A(this,"_metaData",void 0),A(this,"_analyticsData",{numberOfSentencesProcessedForGC:0,numberOfSentencesProcessedForReco:0,errors:[]}),this.gcMergedObservable=e.gcMergedObservable,this.recommendationMergedObservable=e.recommendationMergedObservable,this.paragraphs=t,this.returnFromWs=n,this.startTime=a,this.editorId=r,this.isRecommendationEnabled=o,this._notifyClient=s,this._metaData=i}}function G(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class O{static getInstance(){return O._instance||(O._instance=new O),O._instance}async setConfig(e,t){void 0!==t&&await this._gcService.setConfig(e,t)}async setTransportHttpClient(){this._transport.setHttpClient(C.getInstance())}async setGCHttpClient(e){this._gcService.setGCHttpClient(e)}async setTrackerClient(e){this._gcService.setGCTrackerClient(e)}async setLoggerClient(e){this._gcService.setLoggerClient(e)}async setStorageClient(e){this._gcService.setStorageClient(e)}async setEventCallback(e){this._gcService.setEventCallback(e),this._transport.setEventCallback(e)}async setAdapterConfig(e){let{QUILLBOT_API_URL:t,GC_SUPPORTED_LANGUAGES:n,PREFERRED_MODE:a,RETURN_FROM_WS:r,IS_RECOMMENDATION_ENABLED_FOR_WS:o,...s}=e;n&&(this._GC_SUPPORTED_LANGUAGES=n),e.PLATFORM_TYPE&&(this._PLATFORM_TYPE=e.PLATFORM_TYPE),e.PLATFORM_VERSION&&(this._PLATFORM_VERSION=e.PLATFORM_VERSION),a&&(this._preferredMode=a),void 0!==r&&(this._returnFromWs=r),void 0!==o&&(this._isRecommendationEnabledForWsFlow=o),this._transport.setUserMeta({premium:"true"===s.IS_PREMIUM_USER}),t&&C.getInstance().setAPIUrl(t);let i=["QUILLBOT_API_URL","GC_SUPPORTED_LANGUAGES"];for(let[e,t]of Object.entries(s))i.includes(e)||void 0===t||await this.setConfig(e,t)}transformRequest(e){let t=(e=>{let t=[];for(let n=0;n<(null==e?void 0:e.length);n++){let a=e[n],r={paraID:`${c((a.text||"")+n)}`,id:"gc-editor",text:a.text,startIndex:a.offset,endIndex:a.offset+a.text.length-1,paraType:"text",fontSize:"14px",sentences:[],rteMap:null==a?void 0:a.rteMap};t.push(r)}return t})(e);return{currTextState:{text:"",paragraphsState:t}}}async _detectLanguageIfNeeded(e="",t,n){var r;let[o]=e.split("-")||[];if(o)return{language:o,confidence:1};if(this._inProgressLangDetectRequests.size>1&&this._inProgressLangDetectRequests.clear(),(null==t?void 0:t.length)<15)return{language:h.English.toLowerCase(),confidence:1};let s=(null==t?void 0:t.slice(0,1e3))||"";if(this._inProgressLangDetectRequests.has(s)){let e=await this._inProgressLangDetectRequests.get(s);return{language:e.language,confidence:e.score}}let i=(0,a.detectLanguage)(s,{...n,signal:null!==(r=null==n?void 0:n.signal)&&void 0!==r?r:void 0});this._inProgressLangDetectRequests.set(s,i);let l=await i;return{language:l.language,confidence:l.score}}_getRegion(e,t){var n;if(!t)return"";let[a,r]=t.split("-");return r||(null===(n=null==e?void 0:e.find((e=>e.startsWith(a))))||void 0===n?void 0:n.split("-")[1])||""}async _ensureSpamChecked(){this._hasSpamChecked||(this._hasSpamChecked=!0,await this._gcService.spamCheck())}unsupportedLanguageResponse(e){let t=u(e.language,e.region),n=P._defaultLTResponse();return n.language=P._createLanguageObject("NoopLanguage",t,e.confidence),n}isSupportedLanguage(e){return this._GC_SUPPORTED_LANGUAGES.some((({code:t})=>t===e.toUpperCase()))}_convertRecommendationSentenceIndexToParagraphRelative(e,t){if(0===(null==e?void 0:e.length))return[];let n=JSON.parse(JSON.stringify(t));if(null==n||n.forEach((t=>{t.sentences.forEach((n=>{let a=null==e?void 0:e.find((e=>(null==n?void 0:n.sentenceId)===(null==e?void 0:e.sentenceId)&&(null==t?void 0:t.paraID)===(null==e?void 0:e.paraId)));a&&(n.recommendationResponse=a)}))})),1===n.length)return n[0].sentences[n[0].sentences.length-1].end=n[0].sentences[n[0].sentences.length-1].end+1,n;let a=0;return n.forEach((e=>{var t,n;let r=null==e||null===(t=e.sentences)||void 0===t?void 0:t.length;null==e||null===(n=e.sentences)||void 0===n||n.map(((e,t)=>{var n,o;e.start=e.start+a,e.end=t===r-1?e.end+a+1:e.end+a,null==e||null===(n=e.recommendationResponse)||void 0===n||null===(o=n.recommendations)||void 0===o||o.forEach(((t,n)=>{t.phrases.forEach(((t,r)=>{var o;let s={...t,start:t.start+a,end:t.end+a};(null==e||null===(o=e.recommendationResponse)||void 0===o?void 0:o.recommendations)&&(e.recommendationResponse.recommendations[n].phrases[r]=s),t.phraseDiff&&t.phraseDiff.length>0&&t.phraseDiff.forEach(((t,o)=>{var s,i,l,c,d,g;let u={...t,sourceStart:t.sourceStart+a,sourceEnd:t.sourceEnd+a,targetStart:t.targetStart+a,targetEnd:t.targetEnd+a};(null==e||null===(s=e.recommendationResponse)||void 0===s||null===(i=s.recommendations)||void 0===i||null===(l=i[n])||void 0===l||null===(c=l.phrases)||void 0===c||null===(d=c[r])||void 0===d||null===(g=d.phraseDiff)||void 0===g?void 0:g[o])&&(e.recommendationResponse.recommendations[n].phrases[r].phraseDiff[o]=u)}))}))}))})),a=a+e.text.length+2})),n}_convertSentenceIndexToParagraphRelative(e){if(1===e.length)return e[0].sentences.forEach((e=>{let t=e.text.trimEnd().length,n=e.start+t;e.end=n})),e[0].sentences[e[0].sentences.length-1].end=e[0].sentences[e[0].sentences.length-1].end+1,e;let t=[],n=0;return e.forEach((e=>{let a=e.sentences.length,r=e.sentences.map(((e,t)=>{var r;let o=e.text.trimEnd().length,s=e.start+o;e.start=e.start+n,e.end=t===a-1?s+n+1:s+n;let i=null===(r=e.grammarResponse)||void 0===r?void 0:r.contentToReplace.map((e=>({...e,startIndex:e.startIndex+n,endIndex:e.endIndex+n})));return{...e,grammarResponse:{...e.grammarResponse,contentToReplace:i}}}));n=n+e.text.length+2,t.push({...e,sentences:r})})),t}async handleWsFlow(e){let{input:t,metaData:n,logInfo:{startTime:a,editorId:o},gcDoneCallback:s,recommendationResponseCallback:i,inputShouldCallRecommendation:l,signal:c}=e,d=l&&this._isRecommendationEnabledForWsFlow,g=d?r.ProcessingType.GC_WITH_RECOMMENDATION:r.ProcessingType.GC;g=t.appliedFixAll&&d?r.ProcessingType.RECOMMENDATION:g;let u=t.hasUserAppliedFix||t.appliedFixAll;try{if(!n)throw new r.CustomException(r.CustomErrors.PROCESSING_ERROR,"No metadata found");let[e,l]=(null==t?void 0:t.language)&&(null==t?void 0:t.language.split("-"))||[],m=Date.now().toString(),h=await this._transport.updateEditorContent({editorId:null==n?void 0:n.instanceId,editorGroupId:`editorGroupId-${null==n?void 0:n.tabId}`,editorContentVersion:m,product:r.QB_PRODUCT.GRAMMAR_CHECKER,changeType:u?r.ChangeType.ACCEPT_CHANGES:r.ChangeType.USER_CHANGE,...u&&{acceptChangeType:t.acceptChangeType},editorCompleteText:t.editorCompleteText,changes:t.paragraphs.map((e=>({...e,processingType:g,changeSentenceLength:t.changedParagraphsSentencesLength,...t.hasUserAppliedFix&&{replacementText:null==t?void 0:t.replacementText}}))),hostUrl:null==n?void 0:n.hostUrl,hostCategory:n.hostCategory,meta:{...e&&{language:e},...l&&{userPreferredDialect:l},recommendationApiVersion:2},signal:c});if(h){let{gcMergedObservable:e,recommendationMergedObservable:r}=h,l=new w({gcMergedObservable:e,recommendationMergedObservable:r},t.paragraphs,this._returnFromWs,a,o,d,this._transport.notifyClient,{hostUrl:null==n?void 0:n.hostUrl});return await l.handleGCResponse(s,i)}}catch(e){var m,h,p;if((null==e||null===(m=e.data)||void 0===m?void 0:m.errorCode)===r.MessageErrorCodes.LANGUAGE_NOT_SUPPORTED){let n=t.preferredVariants[0],{langCode:a,confidenceScore:r}=null!==(p=null==e||null===(h=e.data)||void 0===h?void 0:h.language)&&void 0!==p?p:{};return n||(n=this._getRegion(t.preferredVariants,a)),this.unsupportedLanguageResponse({language:a,region:n,confidence:r})}throw e}}async grammarCheck(e){var t,n,o,s,l,c,d,g;try{let{input:o,gcParams:s,gcDoneCallback:l,recommendationResponseCallback:c,signal:d=null,metaData:g}=e,m=this._preferredMode!==i.WS,h=(null==g?void 0:g.hostUrl)&&!(e=>e.includes("docs.google.com"))(null==g?void 0:g.hostUrl),p=this._preferredMode!==i.WS_WITH_NON_GDOCS,v=(m||h)&&p,f=Date.now();if((0,r.logTimeForAction)(r.LogActionPrefix.LT_QB_GC_ADAPTER,{startTime:f,type:"START",editorId:null==g?void 0:g.instanceId}),(!v||this._preferredMode===i.WS_WEBAPP)&&g){let e=async e=>{let[t,n]=e.language&&e.language.split("-")||[];if(t)return e;let r=(0,a.getConfig)("ON_DEVICE_LANGUAGE_CONFIG");if(!(null==r?void 0:r.enabled))return e;let o=e.editorCompleteText.substring(0,1e3),s=await(0,a.detectLanguage)(o,{skipHttpRequest:!0});if(!s.language)return e;let i=n?`${s.language}-${n}`:s.language;return{...e,language:i}},t=await e(o);return await this.handleWsFlow({input:t,metaData:g,gcDoneCallback:l,recommendationResponseCallback:c,inputShouldCallRecommendation:!o.disableRecommendations,logInfo:{startTime:f,editorId:null==g?void 0:g.instanceId},signal:d})||{}}if(v||!this._returnFromWs){let a="true"===await this._gcService.getIsPremium(),i={"x-website-origin":R((null==g?void 0:g.hostUrl)||"")||"","x-website-url":(null==g?void 0:g.hostUrl)||"","platform-type":this._PLATFORM_TYPE,"platform-version":this._PLATFORM_VERSION};await this._ensureSpamChecked();let{currTextState:m}=this.transformRequest(o.paragraphs),{language:h,confidence:p}=await this._detectLanguageIfNeeded(o.language,o.editorCompleteText,{signal:d,headers:i}),v=this._getRegion(o.preferredVariants,o.language||h);if(!this.isSupportedLanguage(h))return this.unsupportedLanguageResponse({language:h,region:v,confidence:p});await this._gcService.setLanguage(h),await this._gcService.setRegionalLanguage(v);let _=e=>{null==l||l(P.transform({paragraphState:[e],langData:{language:h,region:v,confidence:p},isPremium:a}))},C=[],S=!1,E={cache:0,api:0},T=e=>{e.map((e=>{e._cached?E.cache++:e.text&&E.api++}));let t=this._convertRecommendationSentenceIndexToParagraphRelative(e,m.paragraphsState),n=b.transform({paragraphState:t,langData:{language:h,region:v,confidence:p},isPremium:a});S?null==c||c(n):C.push(n)},I=s?{...s,language:null==h?void 0:h.toUpperCase()}:{language:null==h?void 0:h.toUpperCase()},y=u(h,v);i["qb-dialect"]=y;let L={prevState:null,currentState:m,gcParams:I,header:i,hasUserAcceptedSuggestion:o.hasUserAppliedFix,changedParagraphsSentencesLength:o.changedParagraphsSentencesLength,shouldCallRecommendation:!o.disableRecommendations,appliedFixAll:o.appliedFixAll,writingGoal:o.writingGoal,...d&&{signal:d}},{currentTextState:{paragraphsState:D}}=await this._gcService.grammarCheck(L,_,T);S=!0;let A=this._convertSentenceIndexToParagraphRelative(D),w=P.transform({paragraphState:A,langData:{language:h,region:v,confidence:p},isPremium:a}),G=null==C?void 0:C.flatMap((e=>null==e?void 0:e.matches)),O=[...new Set(C.flatMap((e=>{var t,n;return null==e||null===(t=e.metaData)||void 0===t||null===(n=t.textErrors)||void 0===n?void 0:n.recommendationModelId})))],M={...w,matches:[...w.matches,...G],metaData:{textErrors:{errorModelId:null==w||null===(t=w.metaData)||void 0===t||null===(n=t.textErrors)||void 0===n?void 0:n.errorModelId,recommendationModelId:O}}};return this.reportGrammarAnalysisResults(D,G,w,E,e),(0,r.logTimeForAction)(r.LogActionPrefix.LT_QB_GC_ADAPTER,{type:"GC_COMPLETED",mode:"HTTP",startTime:f,currentTime:Date.now(),timeDiff:Date.now()-f,editorId:null==g?void 0:g.instanceId}),M}return{}}catch(n){if((null===(o=e.signal)||void 0===o?void 0:o.aborted)||n instanceof AbortSignal||"AbortError"===(null==n?void 0:n.reason)){let e=Error("AbortError");throw e.reason="AbortError",e}if((null==n?void 0:n.name)===r.CustomErrors.TRANSPORT_NOT_INITIALIZED)throw null===(d=(c=this._transport).trackEvent)||void 0===d||d.call(c,{tracking:{eventName:r.TrackingEvents.TRANSPORT_ERROR,eventData:{category:r.errorCategory.TRANSPORT_NOT_INITIALIZED,errorOrigin:r.errorOrigin.QB_ADAPTER_GC}}}),n;let t={};if((null==n?void 0:n.errorData)&&(t=null==n||null===(g=n.errorData)||void 0===g?void 0:g.data),null===(l=(s=this._transport).trackEvent)||void 0===l||l.call(s,{tracking:{eventName:r.TrackingEvents.PROCESSING_ERROR,eventData:{errorOrigin:r.errorOrigin.QB_ADAPTER_GC,...t}}}),(null==n?void 0:n.name)===r.CustomErrors.PROCESSING_ERROR)throw n;let a=Error(r.CustomErrors.PROCESSING_ERROR);throw a.reason=r.CustomErrors.PROCESSING_ERROR,a}}constructor(){G(this,"_gcService",void 0),G(this,"_hasSpamChecked",!1),G(this,"_GC_SUPPORTED_LANGUAGES",p),G(this,"_PLATFORM_TYPE","chrome-active"),G(this,"_PLATFORM_VERSION",""),G(this,"_transport",void 0),G(this,"_preferredMode",i.LEGACY_HTTP),G(this,"_returnFromWs",!0),G(this,"_isRecommendationEnabledForWsFlow",!0),G(this,"getTransport",(()=>this._transport)),G(this,"_inProgressLangDetectRequests",new Map),G(this,"storeSentenceForSkippingCheck",(async e=>{await this._gcService.storeSentenceForSkippingCheck(e)})),G(this,"trackRecommendationAnalytics",((e,t,n)=>{try{var r,o;let s={cache:0,api:0};e.map((e=>{e._cached?s.cache++:e.text&&s.api++}));let i=t.matches.map((e=>({category:e.rule.category.name,modelID:null==e?void 0:e.rule.modelId,isRecommendation:!0}))),l={eventName:"gc_model_stats",data:{hostUrl:null===(r=n.metaData)||void 0===r?void 0:r.hostUrl,editorID:null===(o=n.metaData)||void 0===o?void 0:o.instanceId,errors:i,numberOfSentencesProcessedForGC:0,numberOfSentencesProcessedForReco:s.api+s.cache}};(0,a.notifyClient)(l)}catch(e){}})),G(this,"recommendation",(async(e,t={})=>{var n,a,r,o,s;let i={"x-website-origin":((null==e||null===(n=e.metaData)||void 0===n?void 0:n.hostUrl)?R(null==e||null===(a=e.metaData)||void 0===a?void 0:a.hostUrl):"")||"","x-website-url":(null==e||null===(r=e.metaData)||void 0===r?void 0:r.hostUrl)||"","platform-type":this._PLATFORM_TYPE,"platform-version":this._PLATFORM_VERSION,"x-regional-language":(null===(o=e.input)||void 0===o||null===(s=o.language)||void 0===s?void 0:s.split("-")[1])||""},l=await this._gcService.forceRecommendation(e.input,{...t,headers:{...t.headers,...i}}),c="true"===await this._gcService.getIsPremium(),d=await this._gcService.getInputLanguage(),g=await this._gcService.getRegionalLangauge(),u=b.transformForceRecommendation({recommendation:l,langData:{language:d,region:g,confidence:0},isPremium:c});return this.trackRecommendationAnalytics(l,u,e),u})),G(this,"detectLanguage",(async(e,t={})=>{let n={"platform-type":this._PLATFORM_TYPE,"platform-version":this._PLATFORM_VERSION};return await(0,a.detectLanguage)(e,{...t,headers:{...t.headers,...n}})})),G(this,"unlockRecommendations",(async(e,t={})=>{try{var n,r,o;let s={"x-website-origin":((null==e||null===(n=e.metaData)||void 0===n?void 0:n.hostUrl)?R(null==e||null===(r=e.metaData)||void 0===r?void 0:r.hostUrl):"")||"","x-website-url":(null==e||null===(o=e.metaData)||void 0===o?void 0:o.hostUrl)||"","platform-type":this._PLATFORM_TYPE,"platform-version":this._PLATFORM_VERSION},i={...t,headers:{...t.headers,...s}},l=await(0,a.unlockRecommendation)(e,i),c="true"===await this._gcService.getIsPremium(),d=await this._gcService.getInputLanguage(),g=await this._gcService.getRegionalLangauge();if(null==l||!l.recommendation)return;return{recommendation:b.transformForceRecommendation({recommendation:[null==l?void 0:l.recommendation],langData:{language:d,region:g,confidence:0},isPremium:c}),quota:null==l?void 0:l.quota}}catch(e){throw e}})),G(this,"reportGrammarAnalysisResults",((e,t,n,r,o)=>{try{var s,i;let l=(e=>{try{let n=0,a=0,r=e.flatMap((e=>null==e?void 0:e.sentences));for(let e of r){var t;!0===(null===(t=e.grammarResponse)||void 0===t?void 0:t._cached)?n++:e.grammarResponse&&""!==e.text&&a++}return{cache:n,api:a,total:n+a}}catch(e){return{cache:0,api:0,total:0}}})(e),c=t.map((e=>({category:null==e?void 0:e.rule.category.name,modelID:null==e?void 0:e.rule.modelId,isRecommendation:!0}))),d=n.matches.map((e=>({category:"",modelID:null==e?void 0:e.rule.modelId,isRecommendation:!1}))),g={eventName:"gc_model_stats",data:{hostUrl:null===(s=o.metaData)||void 0===s?void 0:s.hostUrl,editorID:null===(i=o.metaData)||void 0===i?void 0:i.instanceId,errors:[...c,...d],numberOfSentencesProcessedForGC:l.total,numberOfSentencesProcessedForReco:r.api+r.cache}};(0,a.notifyClient)(g)}catch(e){}})),this._gcService=S.getInstance(),this._transport=r.Transport.getInstance()}}G(O,"_instance",void 0),function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},t=(new Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="5d40a602-5240-5ec2-9f8b-897ecb54d339")}catch(e){}}()}}]);
//# sourceMappingURL=sourceMap/7190.js.map