"use strict";(self.webpackChunkextension=self.webpackChunkextension||[]).push([[4281],{74281:(e,r,t)=>{t.r(r),t.d(r,{PurchaseEventName:()=>F,StoreKitDuration:()=>B,StoreKitSubProvider:()=>q,storekitDurationToPlusDurationMap:()=>T});var n,a=t(89338),u=t(50122),i=t(2827),o=t.n(i),c=t(22155),l=t(14243),s=t(9487),d=t(20573),p=t(63815),f=t(80244),h=t(68390),v=t(16354),P=t(54883),b=t(68392),m=t(92315),y=t(57952),C=t(36899),k=t(49556),g=t(30530),I=t(83362),A=c.createElement,B=function(e){return e.Monthly="P1M",e.Yearly="P1Y",e}({}),T=(n={},(0,u.A)(n,B.Monthly,v.qf.Monthly),(0,u.A)(n,B.Yearly,v.qf.Yearly),n),F=function(e){return e.PurchaseCompleted="PurchaseCompleted",e.PurchaseInitiated="PurchaseInitiated",e.PurchasePending="PurchasePending",e.PurchaseFailed="PurchaseFailed",e.PurchaseError="PurchaseError",e.PurchaseCancelled="PurchaseCancelled",e}({}),M=function(e){return(0,h.HD)("iap-products-result",(function(r){var t=(0,h.hX)(null==r?void 0:r.detail)?[]:r.detail;return e.map((function(e){var r=t.find((function(r){return r.attributes.offerName===e.idMap.ios}));if(!r)return null;var n=T[r.attributes.offers[0].recurringSubscriptionPeriod];return{metadata:e,priceId:e.idMap.ios,price:{amount:parseFloat(r.attributes.offers[0].price),formatted:r.attributes.offers[0].priceFormatted},duration:n,currency:null}})).filter(Boolean)}))},q=function(e){var r,t=e.children,n=e.successCallback,u=(0,s.useRouter)(),i=(0,b.mu)().displayToast,v=(0,f.Z2)(),B=v.user,T=v.isValidRegion,q=(0,m.L)().logSubscriptionEvent,D=(0,c.useRef)();D.current=q;var E,S=(0,l.I)({queryKey:(0,g.$h)(g.jZ.PricePreview,B,"ios","plus"),queryFn:function(){return(0,I.U8)(I.Ey.Plus)},enabled:!!B&&(0,p.B6)(),staleTime:g.b2.Default}).data,w=(0,l.I)({queryKey:["iap-products"],enabled:!(null==S||!S.length)&&(0,p.B6)(),staleTime:g.b2.Default,queryFn:(E=(0,a.A)(o().mark((function e(){var r,t;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((0,p.QD)(p.NB.IAPSubscriptionRequest)){e.next=2;break}return e.abrupt("return",[]);case 2:return r=M(S),t=S.map((function(e){return e.idMap.ios})).filter(Boolean),(0,p.Ks)(p.NB.IAPProductList,t),e.abrupt("return",r);case 6:case"end":return e.stop()}}),e)}))),function(){return E.apply(this,arguments)})}),K=w.data,x=(0,c.useCallback)((function(e){var r,t=e.priceId;(0,p.Ks)(p.NB.IAPSubscriptionRequest,{productId:t,appAccountToken:null==B||null===(r=B.subscriptionFlags)||void 0===r?void 0:r.appAccountToken})}),[null==B||null===(r=B.subscriptionFlags)||void 0===r?void 0:r.appAccountToken]);(0,c.useEffect)((function(){var e="iap-purchase-event";return(0,h.HD)(e,(function(e){var r=e.detail,t=r.name,a=r.detail,o=r.product,c=null==K?void 0:K.find((function(e){var r;return e.priceId===(null==o||null===(r=o.attributes)||void 0===r?void 0:r.offerName)}));switch(t){case F.PurchaseCompleted:D.current({event_name:y.VB.CompleteCheckout,extra:{user_id:null==B?void 0:B.id,cycle:c.duration,localCost:o.attributes.offers[0].price,localCurrency:o.attributes.offers[0].currencyCode,payment:k.d.AppleStoreKit}}),n?n(null):u.push(P.j$);break;case F.PurchaseInitiated:D.current({event_name:y.VB.InitiatePayment});break;case F.PurchaseFailed:D.current({event_name:y.VB.ErrorCheckout,extra:{errorCode:a}}),i(C.XW);break;case F.PurchasePending:i("Please wait for the purchase to be completed.");case F.PurchaseCancelled:}}),{once:!1}),function(){var r;null===globalThis||void 0===globalThis||null===(r=globalThis.eventControllers)||void 0===r||null===(r=r[e])||void 0===r||r.abort()}}),[i,K,S,u,n,null==B?void 0:B.id]);var N=(0,c.useMemo)((function(){return{openCheckout:x,productOptions:K,isPlusAvailable:T,giftOneYear:void 0,isPricesPending:!1}}),[T,x,K]);return A(d.Qv.Provider,{value:N},t)}}}]);